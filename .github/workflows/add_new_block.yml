name: Add Block to Page 1

on:
  workflow_dispatch:  # Allows manual triggering via the GitHub API

jobs:
  add_block:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install jq (JSON processor)
        run: sudo apt-get update && sudo apt-get install jq -y

      - name: Read trigger_block.json
        id: read_trigger_block
        run: |
          echo "::set-output name=trigger_block::$(cat trigger_block.json)"

      - name: Add block to database.js
        run: |
          # Get the trigger_block content from the output of the previous step
          TRIGGER_BLOCK_CONTENT="${{ steps.read_trigger_block.outputs.trigger_block }}"

          # Read the current database.js content
          DATABASE_CONTENT=$(<database.js)

          # Extract the "blocks" array from the JSON content
          BLOCKS_ARRAY=$(echo "$DATABASE_CONTENT" | jq '.pages.page1.blocks')

          # Append the new block to the "blocks" array
          NEW_BLOCKS_ARRAY=$(echo "$BLOCKS_ARRAY + [$TRIGGER_BLOCK_CONTENT]")

          # Replace the "blocks" array in the JSON content with the updated array
          UPDATED_CONTENT=$(echo "$DATABASE_CONTENT" | jq '.pages.page1.blocks = $NEW_BLOCKS_ARRAY')

          # Write the updated JSON content back to the file
          echo "$UPDATED_CONTENT" > database.js

          # Commit the changes and push
          git config --global user.email "timmeeuwsen@hotmail.nl"
          git config --global user.name "timmit147"
          git add database.js
          git commit -m "Add new block to page 1"
          git push -u origin HEAD
